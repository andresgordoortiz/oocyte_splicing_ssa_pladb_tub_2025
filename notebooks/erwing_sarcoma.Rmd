---
title: "Alternative Splicing Analysis"
subtitle: "Erwing sarcoma"
author: "Andrés Gordo Ortiz @Al Jord Lab CRG"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: hide
    code_download: false
    df_print: paged
    number_sections: true

editor_options:
  markdown:
    wrap: 72

header-includes:
  - '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">'
  - '<style>
        /* Base styling */
        body {
          font-family: "Roboto", sans-serif;
          color: #333;
          background-color: #ffffff;
          margin: 0;
          padding: 20px;
        }
        .container {
          max-width: 960px;
          margin: auto;
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 {
          color: #2C3E50;
          text-align: center;
          font-weight: 700;
          margin: 0.5em 0;
        }
        h1 { font-size: 2.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.75em; }
        
        /* Text styling */
        p {
          line-height: 1.6;
          margin-bottom: 1em;
          text-align: justify;
        }
        .subtitle, .author, .date {
          text-align: center;
          color: #2C3E50;
          margin-bottom: 0.5em;
        }
        
        /* Links */
        a {
          color: #0275d8;
          text-decoration: none;
        }
        a:hover {
          text-decoration: underline;
        }
        
        /* Tables */
        table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        th, td {
          border: 1px solid #ddd;
          padding: 10px;
        }
        th {
          background-color: #2C3E50;
          color: #fff;
        }
        tr:nth-child(even) {
          background-color: #f9f9f9;
        }
        tr:hover {
          background-color: #f1f1f1;
        }
     </style>'
---




```{r setup, include=FALSE}
# Ensure a clean environment and load required libraries.
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)


# Load required libraries
library("betAS")
library("ggplot2")
library("plotly")
library("dplyr")
library("tidyverse")
library("cowplot")
library("DT")
library("paletteer")
library("ggupset")
library("showtext")
library("ggtext")
library("readxl")
library("biomaRt")
library("patchwork")
library("org.Mm.eg.db")
library("org.Hs.eg.db")
library("enrichplot")
library("DOSE")
library("clusterProfiler")
library("ComplexHeatmap")
library("enrichR")
library("colorRamp2")
library("dendextend")
library("UpSetR")

# Register Google fonts
showtext_auto()
font_add_google("Roboto", "roboto")
font="roboto"

```

# Introduction to this Analysis

## Part 1: Upstream Analysis

The upstream analysis is performed on the CRG cluster using the Bash command line. This phase involves:

1. **Data Acquisition**:
  - Downloading `*.fastq.gz` files of these studies:
    - **FMN2 DKO Oocytes**
    - **SPIRE1/2 DKO Oocytes**
  - Merging technical replicates for superior sequencing depth. RNA Splicing analysis usually requires a minimum of 50 million reads per biological sample.

2. **Alignment**:
   - Aligning the sequences to the latest mouse genome release (mm10) using **Bowtie2** through the [Vast-Tools align function](https://link.springer.com/protocol/10.1007/978-1-0716-2521-7_7).

3. **Event Detection**:
   - Importing inclusion tables generated by Vast-Tools into RStudio. Vast-Tools does **not** find new splicing events, relaying on a manually curated database, [VASTDB](https://vastdb.crg.eu/), with more than 600.000 splicing events. The end result is an `Inclusion_table.tab`, which contains the splicing events as rows and the samples as columns. Splicing is quantified using the Percentage Spliced-In (PSI) parameter, which shows the percentage at which a given splicing event occurs across all sequencing reads of the gene. The database covers the following splicing events:
   
     - **Exons (EX)**: Cassette sequences that are either included or excluded in the mature mRNA.
     - **Introns (IN)**: Introns that are either retained or spliced out in the mature mRNA.
     - **Alternative 5' Splice Sites (Alt5)**: Exons that are spliced at different 5' sites (donor sites).
     - **Alternative 3' Splice Sites (Alt3)**: Exons that are spliced at different 3' sites (acceptor sites).
     - **Microexons (MIC)**: Exons that are shorter than 27 nucleotides.

---

## Part 2: Statistical Analysis

State-of-Art splicing analysis tools such as the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) employ a combination of statistical testing and simulations on the *beta* distribution to calculate the delta PSI (the difference in splicing between two conditions) and the False Discovery rate (FDR, or adjusted p-value) respectively. This is computationally demanding for such a large dataset. For that reason we focused first on analyzing *alternative* splicing events (that is, events with a PSI different that *0* or *100*--not always active, not always inactive) which constitute ~25% of all events in both *FMN2* and *Spire* studies. With that first analysis done (which can be accessed completely in the file `alternative_splicing_fmn2_spire.html`) we fine-tuned the code and used the complete dataset (using both constitutive and alternative events). Additionally, events with less than 10 supporting reads were filtered out (this is the minimum in the field, allowing for maximum sensibility). The specific steps taken for these analysis were.


1. **Statistical Testing**:
   - Use the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) in R to perform Beta Distribution simulations to obtain:
     - **False Discovery Rate (FDR)**
     - **delta Percentage Spliced-in (dPSI)**

2. **Filtering Criteria**: Significant events are defined by
     - FDR <= 0.05
     - |dPSI| >= 0.1 (out of 1. That is, at least a 10% increase or decrease in PSI)

All the code history can be accessed through its [GitHub Repository](https://github.com/andresgordoortiz/24crg_adel_manu_oocyte_splicing)

---


```{r inclusion tables}

splicing_data <- getDataset(pathTables = paste0(getwd(),"ewing_splicing_PRJNA407215_INCLUSION_LEVELS_FULL-hg19.tab"), tool = "vast-tools")

splicing_events <- filterEvents(getEvents(splicing_data, tool = "vast-tools"), N = 10) 



exons <- filterEvents(splicing_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 10)
introns <- filterEvents(splicing_events, types = c("IR"), N = 1)
alt <- filterEvents(splicing_events, types = c("Alt5", "Alt3"), N = 10)



```


## Metadata { .tabset}

### PladB

```{r metadata pladb}
# Load metadata file containing sample information
metadata<-data.frame(samples=colnames(splicing_events$PSI)[7:10],condition=rep(c("control","siEWS-FLI1"), each=2))
DT::datatable(metadata, options = list(pageLength = nrow(metadata), scrollX = TRUE))
```

---

# Total Splicing Events

This plot shows the total number of splicing events found during the **mapping**, alongside the proportions of each type of event. It is important to know that *vast-tools* does not find new events, but it identifies those manually curated in the database. The total number is the same for both datasets, as it is the total number of events registered and curated in ***VASTDB***, hence the *Complete Version.* 



```{r general stats}
vastdb_events<-read.table("EVENT_INFO-mm10.tab", header = TRUE, sep = "\t")
bin_exons <- function(n) {
  if (is.na(n)) return(NA) # Handle missing values
  else if (n < 6) return("1-5")
  else if (n < 9) return("6-10")
  else if (n < 21) return("11-20")
  else return("21+")
}

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_exons<-vastdb_events[grep("EX", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$exon_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_exons<-apply_bin_exons(vastdb_exons)

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_introns<-vastdb_events[grep("IN", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$intron_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_introns<-apply_bin_exons(vastdb_introns)
exons_per_gene<-read.table("coding_unique_exon_counts_per_genehuman.txt")
colnames(exons_per_gene)<-c("gene","exons")

exons_per_gene$gene <- gsub("\\.\\d+$", "", exons_per_gene$gene)

```

# Inclusion or Exclusion Plots { .tabset}

These plots show the distribution of the splicing change (dPSI) comparing the KO mutant vs the control. If there is a tendency towards inclusion or exclusion, the bell-shaped curve will be shifted to the right or left, respectively. First, I calculated the mean of each event per condition and then I calculated the difference between means for each event. The subtitle shows the Wilcoxon test assessing this possible asymmetry. The area under the curve for both sides (>0 and <0) is shown numerically. Only events with a dPSI greater or lower than 0 are shown for clarity.

## Exons 

### Tubercidin

```{r inclusionumber of exons tub, fig.width=12, fig.height=8}
# ---- Prepare Data -----------------------------------------------------------
# Remove rows with NA in any of the columns needed (columns 7, 8, 9, 10)
introns_df <- introns$PSI %>% 
  filter(complete.cases(select(., 7:9)))

# Compute the averages and PSI difference for each row
exons_df <- exons_df %>% 
  mutate(
    avg_control = rowMeans(select(., 8)),
    avg_siEWS_FLI1 = rowMeans(select(., 7)),
    difference = avg_siEWS_FLI1 - avg_control
  ) %>% 
  filter(difference >= 1 | difference <= -1) %>%  # Filter for differences > 10 or < -10
  mutate(group = if_else(difference < 0, "Skipped", "Included"))

# ---- Normality Check -----------------------------------------------------------
# Use a subset of the data if sample size > 5000 for the Shapiro-Wilk test
set.seed(123)  # For reproducibility
if(nrow(exons_df) > 5000) {
  shapiro_sample <- sample(exons_df$difference, 5000)
  shapiro_test <- shapiro.test(shapiro_sample)
} else {
  shapiro_test <- shapiro.test(exons_df$difference)
}

# Choose statistical test based on normality (alpha = 0.05)
if (shapiro_test$p.value > 0.05) {
  test_result <- t.test(exons_df$difference, mu = 0)
  test_used <- "Student's t-test"
} else {
  test_result <- wilcox.test(exons_df$difference, mu = 0)
  test_used <- "Wilcoxon signed-rank test"
}

# Calculate percentages for inclusion and exclusion
pct_below <- round(mean(exons_df$difference < 0) * 100, 1)
pct_above <- round(mean(exons_df$difference > 0) * 100, 1)
n_samples <- nrow(exons_df)

# ---- Plot -------------------------------------------------------------------

plot_psi_distribution <- ggplot(
  exons_df[abs(exons_df$difference) > 0, ], 
  aes(x = difference)
) +
  geom_histogram(
    aes(y = ..density.., fill = difference > 0), 
    bins = 100, position = "identity", alpha = 0.9, color = "black"
  ) +
  labs(
    title = "PSI Difference Distribution of Exons",
    subtitle = paste(test_used, "p-value:", format(test_result$p.value, digits = 3), "| n:", n_samples),
    x = "ΔPSI (siEWS-FLI1 - Control)",
    y = "Density",
    fill = "Splicing Direction"
  ) +
  theme_classic(base_family = "sans") +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 12),
    # Remove grid lines
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 14, face = "bold")
  ) +
  scale_x_continuous(
    breaks = c(-100, -75, -50, -25, 0, 25, 50, 75, 100)
  ) +
  # Assign colors explicitly to match annotations
  scale_fill_manual(
    values = c("#4BA3C3", "#D62839"),
    labels = c("ΔPSI < 0", "ΔPSI > 0")
  ) +
  # Annotate the percentages with polished label boxes
  annotate("label", x = -65, y = 0.1, hjust = 0, vjust = 0,
           label = sprintf("ΔPSI < 0: %.1f%%", pct_below),
           fill = alpha("white", 0.8), color = "#4BA3C3", size = 5, fontface = "bold",
           label.size = 0.5) +
  annotate("label", x = 65, y = 0.1, hjust = 1, vjust = 0,
           label = sprintf("ΔPSI > 0: %.1f%%", pct_above),
           fill = alpha("white", 0.8), color = "#D62839", size = 5, fontface = "bold",
           label.size = 0.5)

# Save and display the plot
ggsave("final_plots/erwing_psi_distribution.svg", plot_psi_distribution, width = 12, height = 8, dpi = 300)

print(plot_psi_distribution)


```

```{r skewness tub}

ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

# Retrieve gene symbols
gene_conversion <- getBM(
  attributes = c("hgnc_symbol", "ensembl_gene_id"),
  filters = "hgnc_symbol",
  values = exons_df$GENE,
  mart = ensembl
)

# Merge gene symbols and exon counts
exons_df <- exons_df %>%
  left_join(gene_conversion %>% select(hgnc_symbol, ensembl_gene_id), by = c("GENE" = "hgnc_symbol")) %>%
  left_join(exons_per_gene %>% select(gene, exons), by = c("ensembl_gene_id" = "gene")) %>%
  rename(numb_exons = exons)


library(dplyr)
library(ggplot2)
library(purrr)

set.seed(123)

# 1. Manual skewness
skewness_manual <- function(x) {
  x <- na.omit(x)
  n <- length(x)
  if (n < 3) return(NA_real_)
  m <- mean(x); s <- sd(x)
  sum((x - m)^3) / n / (s^3)
}

# 2. Bin the data
binned <- exons_df %>%
  filter(abs(difference) > 0, !is.na(numb_exons)) %>%
  mutate(
    exon_bin = cut(numb_exons,
                   breaks = c(0, 10, 50, Inf),
                   labels = c("1–10", "11–50", "51+"),
                   right = TRUE)
  ) %>%
  filter(!is.na(exon_bin))

# 3. Bootstrap skewness per bin
boot_results <- binned %>%
  group_by(exon_bin) %>%
  summarise(
    boot_skews = list(replicate(
      1000,
      skewness_manual(sample(difference, replace = TRUE))
    )),
    .groups = "drop"
  ) %>%
  mutate(
    skew_estimate = map_dbl(boot_skews, ~ mean(.x, na.rm = TRUE)),
    ci_lower      = map_dbl(boot_skews, ~ quantile(.x, 0.025, na.rm = TRUE)),
    ci_upper      = map_dbl(boot_skews, ~ quantile(.x, 0.975, na.rm = TRUE)),
    significant   = (ci_lower > 0) | (ci_upper < 0)
  )


library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)

font_add_google(name = "Courier Prime", family = "Courier Prime") 
library(showtext)
showtext_auto()

boot_long <- boot_results %>%
  mutate(exon_bin = factor(exon_bin,
                           levels = c("1–10", "11–50", "51+"))) %>%
  unnest(boot_skews)

p <- ggplot(boot_results,
            aes(x = exon_bin, y = skew_estimate)) +
  
  # jittered bootstraps
  geom_jitter(data = boot_long,
              aes(fill = exon_bin, y = boot_skews),
              position = position_jitter(width = 0.15, height = 0),
              shape = 21,
              color = "gray30", 
              size = 2,
              alpha = 0.05,
              stroke = 0.8) +

  # polynomial regression (2nd degree)
  geom_smooth(data = boot_long,
              aes(x = as.numeric(exon_bin), y = boot_skews),
              method = "lm", formula = y ~ poly(x, 2),
              se = FALSE,
              linetype = "dashed",
              color = "grey40",    # grey line
              size = 1.5) +        # thicker

  # main points
  geom_point(aes(fill = exon_bin, color = significant, shape = significant),
             size = 4, alpha = 0.9, stroke = 1) +

  scale_fill_manual(values = c(
    "1–10"  = "#d1cbe5",
    "11–50" = "#9671bd",
    "51+"   = "#6a408d"
  ), name = "Exon Bin",
     guide = guide_legend(override.aes = list(shape = 21, 
                                             alpha = 1,
                                             size = 4,
                                             color = "gray30"))) +
            

  # significance aesthetics
  scale_color_manual(values = c(`TRUE`  = "#378d94",
                                `FALSE` = "grey60"),
                     name = "Significant") +
  scale_shape_manual(values = c(`TRUE` = 17, `FALSE` = 16),
                     name = "Significant") +

  # densify grid on y-axis
  scale_y_continuous(
    breaks = pretty_breaks(n = 5),         # fewer major
    minor_breaks = waiver(),               # you can specify seq(min, max, length.out) here
    expand = expansion(add = 0.1)
  ) +

  # densify grid on x-axis
  scale_x_discrete(expand = expansion(add = 0.5)) +

  # labels
  labs(
    title = "Bootstrapped Skewness of Splicing Ewing Sarcoma",
    x     = "Number of exons per gene",
    y     = "Skewness of ΔPSI Distribution"
  ) +

  # theme tweaks
  # theme tweaks
  theme_minimal(base_family = "Courier Prime") +
  theme(
    aspect.ratio     = 1,
    legend.position  = "top",
    legend.direction = "horizontal",

    # Remove grid lines, but keep the square
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),

    # add a border around the panel
    panel.border     = element_rect(fill = NA,
                                    color = alpha("black", 0.3),
                                    size = 0.5),

    plot.title       = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.title       = element_text(size = 12),
    axis.text        = element_text(size = 10),
  ) +

  # Add a grey line at y = 0
  geom_hline(yintercept = 0, color = "grey50", linetype = "solid", size = 0.5)

print(p)


ggsave("erwing_exons.svg",
       width  = 6,
       height = 6)

```



# PCA Plot { .tabset}


```{r pca calculation pladb}
# Subset and scale data
pca_splicing <- splicing_events$PSI[, c("EVENT",splicing_events$Samples)] %>%
  na.omit()

rownames(pca_splicing)<- pca_splicing$EVENT
pca_splicing<-t(pca_splicing[,-1])


pca_result <- prcomp(pca_splicing)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-metadata$condition
```

```{r pca plotting pladb}
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition))) +
  geom_point(size = 6, alpha = 0.9) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result)$importance[2, 2], 1), "%)", sep = ""),
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = "sans") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14, margin = margin(t = 10)),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  scale_color_paletteer_d("MetBrewer::Hokusai3") +
  coord_fixed()
ggsave("final_plots/pca_pladb.svg", pca_plot, width = 5, height = 5, dpi = 300)


pca_plot

```

```{r go}
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
library(ggplot2)
library(cowplot)

# ---- INPUT ----
# assume common_genes exists as a character vector of gene SYMBOLs
# e.g. common_genes <- c("TP53","BRCA1",...)
genes <- unique(as.character(common_genes))

# safety check
if(length(genes) == 0) stop("common_genes is empty. Provide a character vector of gene symbols.")

# ---- Run enrichGO for each ontology ----
ontologies <- c(BP = "BP", CC = "CC", MF = "MF")
ego_list <- list()

for(ont in names(ontologies)){
    ego <- tryCatch(
        enrichGO(
            gene          = genes,
            OrgDb         = org.Hs.eg.db,
            keyType       = "SYMBOL",   # change to "ENTREZID" or "ENSEMBL" if your IDs differ
            ont           = ontologies[ont],
            pAdjustMethod = "BH",
            pvalueCutoff  = 0.05,
            qvalueCutoff  = 0.05,
            readable      = TRUE
        ),
        error = function(e) NULL
    )
    ego_list[[ont]] <- ego
}

# ---- Helper: test significance and make plot objects ----
plot_list <- list()
signif_info <- list()

for(ont in names(ego_list)){
    ego <- ego_list[[ont]]
    if(is.null(ego) || nrow(as.data.frame(ego)) == 0){
        signif_info[[ont]] <- "no_enrichment"
        plot_list[[ont]] <- NULL
        next
    }
    res_df <- as.data.frame(ego)
    # decide significance by qvalue (if not present, use p.adjust)
    sig_df <- subset(res_df, !is.na(qvalue) & qvalue < 0.05)
    if(nrow(sig_df) == 0){
        sig_df <- subset(res_df, !is.na(p.adjust) & p.adjust < 0.05)
    }
    if(nrow(sig_df) == 0){
        signif_info[[ont]] <- "no_significant_terms"
        plot_list[[ont]] <- NULL
    } else {
        signif_info[[ont]] <- paste0(nrow(sig_df), " significant terms")
        # make a dotplot (returns a ggplot object)
        # showCategory: choose min(15, number of significant terms)
        ncat <- min(15, nrow(sig_df))
        p <- dotplot(ego, showCategory = ncat) + ggtitle(paste0(ont, " (", ncat, " top terms)")) +
            theme_minimal(base_size = 12) + theme(plot.title = element_text(hjust = 0.5))
        plot_list[[ont]] <- p
    }
}

# ---- Compose final figure ----
# collect non-null plots in ontology order BP, CC, MF
final_plots <- lapply(c("BP","CC","MF"), function(x) plot_list[[x]])
final_plots <- Filter(Negate(is.null), final_plots)

if(length(final_plots) == 0){
    message("No significant GO terms found for BP, CC, or MF (at q < 0.05 / p.adjust < 0.05).")
    # print a short summary
    print(signif_info)
} else {
    # arrange plots horizontally; automatically adapt rows/cols
    n <- length(final_plots)
    cols <- min(3, n)
    combined <- plot_grid(plotlist = final_plots, ncol = cols, align = "h")
    
    # add a title annotation if desired
    title <- ggdraw() + draw_label("GO Enrichment (Biological Process / Cellular Component / Molecular Function)", fontface = 'bold', x = 0.5, hjust = 0.5)
    final_figure <- plot_grid(title, combined, ncol = 1, rel_heights = c(0.06, 1))
    
    # show in R
    print(final_figure)
    
    # save to file
    ggsave("GO_enrichment_combined_ewing.png", final_figure, width = 14, height = 6 * ceiling(n/3), dpi = 300)
    message("Saved figure to: GO_enrichment_combined.png")
    # also save each plot separately if you like:
    for(ont in c("BP","CC","MF")){
        p <- plot_list[[ont]]
        if(!is.null(p)){
            ggsave(sprintf("GO_%s_dotplot_ewing.png", ont), p, width = 6, height = 5, dpi = 300)
        }
    }
    # print small summary
    print(signif_info)
}
```

