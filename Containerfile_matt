# Definitive containerfile: ubuntu 18.04 + host-matching user + matt on PATH + R, Bioconductor helper, sra-toolkit
FROM ubuntu:18.04
ARG UID=1000
ARG GID=1000
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8

# Install build tools, R, sra-toolkit, and helpful libraries for R packages & Perl
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    git \
    wget \
    bzip2 \
    ca-certificates \
    sed \
    curl \
    locales \
    r-base \
    sra-toolkit \
    perl \
    libwww-perl \
    liblwp-protocol-https-perl \
    libxml2-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    python3-numpy \
    python3-scipy \
    texlive-latex-base \
    texlive-latex-extra && \
    ln -sf /usr/bin/python3 /usr/bin/python && \
    locale-gen en_US.UTF-8 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create host-like group/user so mounted files match ownership
RUN groupadd -g ${GID} hostuser || true && \
    useradd -m -u ${UID} -g ${GID} hostuser || true

# Directories
RUN mkdir -p /opt/software /data /usr/local/bin
WORKDIR /opt/software

# Clone matt repo
RUN git clone https://gitlab.com/aghr/matt.git . && \
    chmod u+rwx ./INSTALL && \
    chown -R hostuser:hostuser /opt/software

# Create a wrapper script for matt that sets umask
RUN printf '#!/bin/bash\numask 0000\nexport TMPDIR=/tmp\nexec /opt/software/matt "$@"\n' > /usr/local/bin/matt && \
    chmod +x /usr/local/bin/matt

# Put /usr/local/bin BEFORE /opt/software in PATH so wrapper is found first
ENV PATH=/usr/local/bin:/opt/software:$PATH

# Ensure /tmp has proper permissions
RUN chmod 1777 /tmp

# Silence legacy warnings
ENV CFLAGS="-Wno-old-style-definition"

# Pre-install BiocManager and common Bioconductor packages
RUN Rscript -e 'if (!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager", repos="https://cloud.r-project.org")'
RUN Rscript -e 'BiocManager::install(c("Biostrings","GenomicRanges","IRanges","GenomicFeatures","AnnotationDbi","GenomicAlignments"), ask=FALSE, update=FALSE)'

# Pre-install some common CRAN packages that matt may need
RUN Rscript -e 'options(repos="https://cloud.r-project.org"); pkgs <- c("optparse","data.table","ggplot2","reshape2"); inst <- pkgs[!sapply(pkgs, requireNamespace, quietly=TRUE)]; if(length(inst)) install.packages(inst)'

# Replace deprecated bioconductor.org/biocLite.R URLs with the functional GitHub URL in R and Perl files
RUN find /opt/software -type f \( -name "*.R" -o -name "*.r" -o -name "*.pl" -o -name "*.pm" \) -exec \
    sed -i 's|https\?://bioconductor\.org/biocLite\.R|https://raw.githubusercontent.com/Bioconductor/LegacyInstall/devel/biocLite.R|g' {} \;

# Set global umask in /etc/profile before switching to hostuser
RUN echo "umask 0000" >> /etc/profile

# Make sure permissions are hostuser-owned
RUN chown -R hostuser:hostuser /opt/software

# Switch to host-like user before running INSTALL
USER hostuser
ENV HOME=/home/hostuser
WORKDIR /opt/software

# Run the repo's INSTALL non-interactively (answers 'yes' to prompts)
RUN bash -lc "yes | ./INSTALL"

# Replace deprecated URLs again after INSTALL (in case any files were generated/modified)
RUN find /opt/software -type f \( -name "*.R" -o -name "*.r" -o -name "*.pl" -o -name "*.pm" \) -exec \
    sed -i 's|https\?://bioconductor\.org/biocLite\.R|https://raw.githubusercontent.com/Bioconductor/LegacyInstall/devel/biocLite.R|g' {} \;

# Disable renv auto-loading to prevent biocLite.R download errors
ENV RENV_CONFIG_AUTOLOADER_ENABLED=FALSE

# Set umask to ensure created directories and files have write permissions
# This is applied when bash starts as a login shell
RUN echo "umask 0000" >> /home/hostuser/.bashrc && \
    echo "umask 0000" >> /home/hostuser/.profile

# Switch default workdir to /data
WORKDIR /data

# Default to bash with login shell to apply umask settings
CMD ["/bin/bash", "-l"]